<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نظام إدارة شهادات التحليل الكيماوي</title>
  <style>
    body {font-family: Arial, sans-serif; background:#f8f9fa; margin:20px;}
    h1 {color:#2c3e50; text-align:center;}
    .btn {padding:10px 15px; border:none; border-radius:8px; cursor:pointer; margin:3px;}
    .btn-primary {background:#3498db; color:#fff;}
    .btn-info {background:#17a2b8; color:#fff;}
    .btn-danger {background:#e74c3c; color:#fff;}
    .item-card {
      background:#fff; border-radius:10px; padding:15px; margin:10px;
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
      display:inline-block; vertical-align:top; width:220px; text-align:center;
    }
    .item-card img {max-width:100%; border-radius:8px; margin-bottom:10px;}
    .item-actions {margin-top:10px;}
    .modal {
      display:none; position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.6); justify-content:center; align-items:center;
    }
    .modal-content {
      background:#fff; padding:20px; border-radius:12px; max-width:400px; width:90%;
      text-align:center;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head>
<body>
  <h1>📑 نظام إدارة شهادات التحليل الكيماوي</h1>
  <button class="btn btn-primary" onclick="showAddCertificateModal()">➕ إضافة شهادة</button>
  <div id="certificatesContainer"></div>

  <!-- نافذة إضافة شهادة -->
  <div class="modal" id="addCertificateModal">
    <div class="modal-content">
      <h2>إضافة شهادة جديدة</h2>
      <input type="text" id="certificateName" placeholder="اسم المادة" style="width:100%;padding:8px;margin:5px 0;">
      <input type="file" id="certificateImage" accept="image/*" style="width:100%;padding:8px;margin:5px 0;">
      <div style="margin-top:15px;">
        <button class="btn btn-primary" onclick="addNewCertificate()">حفظ</button>
        <button class="btn" onclick="hideAddCertificateModal()">إلغاء</button>
      </div>
    </div>
  </div>

  <script>
    let certificates = JSON.parse(localStorage.getItem("certificates") || "[]");

    function saveDataToStorage() {
      localStorage.setItem("certificates", JSON.stringify(certificates));
    }

    function showAddCertificateModal() {
      document.getElementById('addCertificateModal').style.display = 'flex';
    }

    function hideAddCertificateModal() {
      document.getElementById('addCertificateModal').style.display = 'none';
    }

    function addNewCertificate() {
      const name = document.getElementById('certificateName').value.trim();
      const imageInput = document.getElementById('certificateImage');
      let imageUrl = "";

      if (!name) return alert("أدخل اسم المادة");

      if (imageInput.files.length > 0) {
        const file = imageInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          imageUrl = e.target.result;
          saveCertificate(name, imageUrl);
        };
        reader.readAsDataURL(file);
      } else {
        saveCertificate(name, imageUrl);
      }
    }

    function saveCertificate(name, imageUrl) {
      certificates.push({ id: Date.now(), name, image: imageUrl });
      saveDataToStorage();
      renderCertificates();
      hideAddCertificateModal();
      document.getElementById('certificateName').value = '';
      document.getElementById('certificateImage').value = '';
    }

    function deleteCertificate(id) {
      certificates = certificates.filter(c => c.id !== id);
      saveDataToStorage();
      renderCertificates();
    }

    function renderCertificates() {
      const container = document.getElementById('certificatesContainer');
      if (certificates.length === 0) {
        container.innerHTML = "<p style='color:#666;text-align:center;'>لا توجد شهادات بعد</p>";
        return;
      }

      container.innerHTML = certificates.map(c => {
        const qrUrl = `${window.location.origin}${window.location.pathname}#certificate-${c.id}`;
        return `
          <div class="item-card">
            <h3 style="color:#8e44ad;">${c.name}</h3>
            ${c.image ? `<img src="${c.image}" alt="صورة الشهادة">` : ""}
            <div id="qrcode-${c.id}" style="margin:10px 0;"></div>
            <div class="item-actions">
              <button class="btn btn-info" onclick="showCertificateDetails(${c.id})">👁 عرض</button>
              <button class="btn btn-danger" onclick="deleteCertificate(${c.id})">🗑 حذف</button>
            </div>
          </div>
        `;
      }).join("");

      certificates.forEach(c => {
        const baseUrl = window.location.origin + window.location.pathname;
        const url = `${baseUrl}#certificate-${c.id}`;
        generateQRCode(`qrcode-${c.id}`, url);
      });
    }

    function generateQRCode(elementId, data) {
      const qrContainer = document.getElementById(elementId);
      qrContainer.innerHTML = "";
      new QRCode(qrContainer, { text: data, width: 128, height: 128 });
    }

    function showCertificateDetails(id) {
      const cert = certificates.find(c => c.id === id);
      if (!cert) return;

      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="modal-content">
          <h2>${cert.name}</h2>
          ${cert.image ? `<img src="${cert.image}" style="max-width:100%;margin:15px 0;">` : '<p style="color:#888;">لا توجد صورة للشهادة</p>'}
          <button class="btn" onclick="this.closest('.modal').remove()">إغلاق</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // 🔗 فتح الشهادة مباشرة من الرابط (عند المسح)
    window.addEventListener("hashchange", () => {
      const hash = window.location.hash;
      if (hash.startsWith("#certificate-")) {
        const id = parseInt(hash.replace("#certificate-", ""));
        showCertificateDetails(id);
      }
    });

    window.addEventListener("load", () => {
      const hash = window.location.hash;
      if (hash.startsWith("#certificate-")) {
        const id = parseInt(hash.replace("#certificate-", ""));
        showCertificateDetails(id);
      }
    });

    renderCertificates();
  </script>
</body>
</html>
